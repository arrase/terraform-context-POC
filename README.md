# Terraform Graph to Neo4j Ingestion

This project automates the ingestion of Terraform's dependency graph into a Neo4j database for analysis and visualization.

## ğŸ“‹ Prerequisites

- Python 3.8 or higher
- [Terraform](https://www.terraform.io/downloads) installed
- [Graphviz](https://graphviz.org/download/) installed (for the `dot` command)
- [Neo4j](https://neo4j.com/download/) database (local or remote)

### System Dependencies Installation

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install -y graphviz terraform
```

**macOS:**
```bash
brew install graphviz terraform
```

**Windows:**
- Download and install Graphviz from https://graphviz.org/download/
- Download and install Terraform from https://www.terraform.io/downloads

## ğŸš€ Installation

1. **Clone or download the project:**
```bash
cd terraform-context
```

2. **Create a virtual environment (recommended):**
```bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

3. **Install Python dependencies:**
```bash
pip install -r requirements.txt
```

4. **Configure environment variables:**
```bash
cp .env.example .env
```

Edit the `.env` file with your Neo4j credentials:
```env
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=your_password
```

## ğŸ“Š Usage

### Basic Usage

Navigate to your Terraform directory and run:

```bash
# Generate Terraform graph and ingest into Neo4j
python /path/to/terraform-context/main.py
```

This command:
1. Runs `terraform graph | dot -Tjson > graph.json`
2. Parses the resulting JSON file
3. Ingests nodes and relationships into Neo4j

### Advanced Options

**Use an existing graph file:**
```bash
python main.py --graph-file my_graph.json --skip-generate
```

**Don't clear existing data in Neo4j:**
```bash
python main.py --no-clear
```

**Help:**
```bash
python main.py --help
```

## ğŸ”§ Project Structure

```
terraform-context/
â”œâ”€â”€ main.py                 # Main script
â”œâ”€â”€ graph_parser.py         # Graph JSON parser
â”œâ”€â”€ neo4j_connector.py      # Neo4j connector
â”œâ”€â”€ requirements.txt        # Python dependencies
â”œâ”€â”€ .env.example           # Configuration template
â”œâ”€â”€ .env                   # Configuration (not versioned)
â”œâ”€â”€ .gitignore            # Files ignored by Git
â””â”€â”€ README.md             # This documentation
```

## ğŸ“¦ Modules

### `graph_parser.py`
Parses the JSON file generated by `terraform graph | dot -Tjson` and extracts:
- **Nodes**: Terraform resources
- **Edges**: Dependencies between resources
- **Metadata**: Graph information

### `neo4j_connector.py`
Manages the connection to Neo4j and provides methods to:
- Connect/disconnect from the database
- Clear the database
- Create constraints
- Ingest nodes and relationships
- Get statistics

### `main.py`
Orchestrates the entire process:
1. Generates the Terraform graph (optional)
2. Parses the JSON
3. Connects to Neo4j
4. Ingests the data

## ğŸ” Example Neo4j Queries

Once the data is ingested, you can run Cypher queries in Neo4j Browser:

**View all nodes and relationships (limited):**
```cypher
MATCH (n)-[r]->(m)
RETURN n, r, m
LIMIT 25
```

**Count nodes and relationships:**
```cypher
MATCH (n:TerraformResource)
OPTIONAL MATCH ()-[r:DEPENDS_ON]->()
RETURN count(DISTINCT n) AS nodes, count(r) AS relationships
```

**Find resources without dependencies:**
```cypher
MATCH (n:TerraformResource)
WHERE NOT (n)-[:DEPENDS_ON]->()
RETURN n
```

**Find root resources (without incoming dependencies):**
```cypher
MATCH (n:TerraformResource)
WHERE NOT ()-[:DEPENDS_ON]->(n)
RETURN n
```

**View the dependency chain of a specific resource:**
```cypher
MATCH path = (n:TerraformResource {name: 'resource_name'})-[:DEPENDS_ON*]->()
RETURN path
```

## ğŸ› Troubleshooting

### Error: "terraform command not found"
- Make sure Terraform is installed and in your PATH

### Error: "dot command not found"
- Install Graphviz following your operating system's instructions

### Error: "Failed to connect to Neo4j"
- Verify that Neo4j is running
- Check the credentials in the `.env` file
- Verify the connection URI (bolt://localhost:7687 by default)

### Error: "Unable to resolve import"
- Activate the virtual environment: `source venv/bin/activate`
- Reinstall dependencies: `pip install -r requirements.txt`

### Graph is empty
- Make sure you're in a directory with Terraform files
- Run `terraform init` first if necessary

## ğŸ“ Notes

- The `terraform graph` command must be run in a directory containing Terraform configuration
- The project clears the Neo4j database by default before ingesting data (use `--no-clear` to avoid this)
- Nodes are created with the `TerraformResource` label
- Relationships are created with the `DEPENDS_ON` type

## ğŸ¤ Contributing

Contributions are welcome. Please:
1. Fork the project
2. Create a branch for your feature (`git checkout -b feature/new-feature`)
3. Commit your changes (`git commit -am 'Add new feature'`)
4. Push to the branch (`git push origin feature/new-feature`)
5. Open a Pull Request

## ğŸ“„ License

This project is open source and available under the MIT license.
